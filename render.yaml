# ============================================
# ğŸš€ Render Deployment Configuration
# ============================================

services:
  # Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  - type: web
    name: whatsapp-telegram-bot
    env: node
    region: frankfurt  # Ø£Ùˆ Ø£ÙŠ Ù…Ù†Ø·Ù‚Ø© Ù‚Ø±ÙŠØ¨Ø© Ù…Ù†Ùƒ
    buildCommand: |
      npm ci --only=production
      npm run migrate
    startCommand: npm start
    healthCheckPath: /health
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: DB_HOST
        fromDatabase:
          name: whatsapp-bot-db
          property: host
      - key: DB_PORT
        value: 3306
      - key: DB_NAME
        fromDatabase:
          name: whatsapp-bot-db
          property: database
      - key: DB_USER
        fromDatabase:
          name: whatsapp-bot-db
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: whatsapp-bot-db
          property: password
      - key: DEFAULT_ADMIN_ID
        sync: false
      - key: SESSION_SECRET
        generateValue: true
      - key: ENCRYPTION_KEY
        generateValue: true
      - key: PORT
        value: 3000
      - key: TZ
        value: Asia/Riyadh
    disk:
      name: sessions
      mountPath: /opt/render/project/src/sessions
      sizeGB: 1
    disk:
      name: logs
      mountPath: /opt/render/project/src/logs
      sizeGB: 1
    plan: starter
    numInstances: 1
    scaling:
      minInstances: 1
      maxInstances: 3
      targetMemoryPercent: 70
      targetCPUPercent: 70

  # Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª MySQL
  - type: pserv
    name: whatsapp-bot-db
    env: docker
    region: frankfurt
    disk:
      name: data
      mountPath: /var/lib/mysql
      sizeGB: 10
    dockerfilePath: ./docker/mysql.Dockerfile
    envVars:
      - key: MYSQL_ROOT_PASSWORD
        generateValue: true
      - key: MYSQL_DATABASE
        value: whatsapp_bot
      - key: MYSQL_USER
        value: whatsapp_user
      - key: MYSQL_PASSWORD
        generateValue: true
      - key: TZ
        value: Asia/Riyadh
    plan: starter
    scaling:
      minInstances: 1
      maxInstances: 1

  # Ø®Ø¯Ù…Ø© Redis Ù„Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
  - type: redis
    name: whatsapp-bot-cache
    region: frankfurt
    ipAllowList:
      - source: 0.0.0.0/0
        description: everywhere
    maxmemoryPolicy: allkeys-lru
    plan: starter
    scaling:
      minInstances: 1
      maxInstances: 1

  # Ø®Ø¯Ù…Ø© Cron Ù„Ù„ØµÙŠØ§Ù†Ø©
  - type: cron
    name: whatsapp-bot-maintenance
    env: node
    region: frankfurt
    schedule: "0 2 * * *"  # ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹
    buildCommand: npm ci --only=production
    startCommand: node scripts/maintenance.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: DB_HOST
        fromService:
          type: pserv
          name: whatsapp-bot-db
          property: host
      - key: DB_PORT
        value: 3306
      - key: DB_NAME
        fromService:
          type: pserv
          name: whatsapp-bot-db
          property: database
      - key: DB_USER
        fromService:
          type: pserv
          name: whatsapp-bot-db
          property: user
      - key: DB_PASSWORD
        fromService:
          type: pserv
          name: whatsapp-bot-db
          property: password

# Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
envVarGroups:
  - name: production
    envVars:
      - key: LOG_LEVEL
        value: info
      - key: WHATSAPP_TIMEOUT
        value: "60000"
      - key: WHATSAPP_MAX_SESSIONS
        value: "5"
      - key: AUTO_BACKUP
        value: "true"
      - key: CLEANUP_DAYS
        value: "7"
      - key: NOTIFY_ON_ERROR
        value: "true"

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
networking:
  - name: whatsapp-network
    service: whatsapp-telegram-bot
    type: private

# Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø±
deployHooks:
  - name: Run Migrations
    type: pre-deploy
    command: npm run migrate
    service: whatsapp-telegram-bot
  - name: Run Tests
    type: pre-deploy
    command: npm test
    service: whatsapp-telegram-bot
  - type: post-deploy
    name: Health Check
    command: |
      sleep 30
      curl -f http://localhost:$PORT/health || exit 1
    service: whatsapp-telegram-bot

# Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
alerts:
  - type: latency
    threshold: 2000ms
    window: 5m
    service: whatsapp-telegram-bot
  - type: error_rate
    threshold: 5%
    window: 5m
    service: whatsapp-telegram-bot
  - type: downtime
    service: whatsapp-telegram-bot
  - type: cpu
    threshold: 80%
    window: 5m
    service: whatsapp-telegram-bot
  - type: memory
    threshold: 80%
    window: 5m
    service: whatsapp-telegram-bot

# Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
backups:
  - name: daily-backup
    schedule: "0 2 * * *"
    database: whatsapp-bot-db
    retentionDays: 7
  - name: weekly-backup
    schedule: "0 2 * * 0"
    database: whatsapp-bot-db
    retentionDays: 30
  - name: monthly-backup
    schedule: "0 2 1 * *"
    database: whatsapp-bot-db
    retentionDays: 365

# Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©
volumes:
  - name: sessions
    mountPath: /opt/render/project/src/sessions
    sizeGB: 1
  - name: logs
    mountPath: /opt/render/project/src/logs
    sizeGB: 1
