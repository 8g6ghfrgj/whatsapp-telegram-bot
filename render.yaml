# ============================================
# Ù…Ù„Ù Blueprint Ù„ØªÙƒÙˆÙŠÙ† Render.com
# WhatsApp-Telegram Bot - Ø®Ø·Ø© Ù…Ø¯ÙÙˆØ¹Ø©
# ============================================

# Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
name: whatsapp-telegram-bot
region: frankfurt  # Ø£Ùˆ Ø£ÙŠ Ù…Ù†Ø·Ù‚Ø© Ù‚Ø±ÙŠØ¨Ø© Ù…Ù†Ùƒ
branch: main
buildFilter:
  paths:
    - "**"

# ============================================
# 1. Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª PostgreSQL (Ù…Ø·Ù„ÙˆØ¨Ø©)
# ============================================
databases:
  - name: whatsapp-bot-db
    databaseName: whatsapp_bot
    user: whatsapp_bot_user
    region: frankfurt
    plan: starter  # ÙŠØ¨Ø¯Ø£ Ù…Ù† $7/Ø´Ù‡Ø±ØŒ Ø£Ùˆ free Ù„Ù„Ù…Ø¬Ø§Ù†ÙŠ
    ipAllowList: []  # Ø§Ù„Ø³Ù…Ø§Ø­ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª PostgreSQL Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
    postgresMajorVersion: "15"
    terminationProtection: false
    
    # Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    automaticBackups: true
    backupRetention: 7  # Ø£ÙŠØ§Ù…
    
    # Ù…Ø±Ø§Ù‚Ø¨Ø©
    monitoring:
      enabled: true
      alerts:
        - type: cpu
          threshold: 80
          duration: "5m"
        - type: memory
          threshold: 85
          duration: "5m"
        - type: disk
          threshold: 90
          duration: "10m"

# ============================================
# 2. Ø®Ø¯Ù…Ø© Worker Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù„Ù„Ù€ Bot)
# ============================================
services:
  - type: worker
    name: whatsapp-bot-worker
    env: node
    region: frankfurt
    plan: standard  # Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù€ PuppeteerØŒ ÙŠØ¨Ø¯Ø£ Ù…Ù† $7/Ø´Ù‡Ø±
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
    buildCommand: |
      echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ WhatsApp-Telegram Bot..."
      npm ci --only=production
      npx playwright install-deps  # ØªØ«Ø¨ÙŠØª dependencies Ø§Ù„Ù†Ø¸Ø§Ù…
      npx playwright install chromium --with-deps
      npm run puppeteer-install
      echo "âœ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§ÙƒØªÙ…Ù„"
    
    # Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø¡
    startCommand: npm start
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
    envVars:
      - key: NODE_ENV
        value: production
      - key: RENDER
        value: "true"
      - key: DATABASE_URL
        fromDatabase:
          name: whatsapp-bot-db
          property: connectionString
      - key: LOG_LEVEL
        value: info
      - key: LOG_TO_FILE
        value: "true"
      - key: WHATSAPP_SESSION_DIR
        value: /tmp/sessions
      - key: WHATSAPP_MAX_SESSIONS
        value: "5"
      - key: BROWSER_HEADLESS
        value: "true"
      - key: AUTO_POST_INTERVAL
        value: "1000"
      - key: AUTO_JOIN_ENABLED
        value: "true"
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Puppeteer Ø§Ù„Ù…Ù‡Ù…Ø©
    envVars:
      - key: PUPPETEER_EXECUTABLE_PATH
        value: /usr/bin/chromium-browser
      - key: BROWSER_ARGS
        value: --no-sandbox,--disable-setuid-sandbox,--disable-dev-shm-usage,--disable-accelerated-2d-canvas,--disable-gpu,--window-size=1920x1080,--single-process
      - key: PUPPETEER_SKIP_CHROMIUM_DOWNLOAD
        value: "false"
      - key: PUPPETEER_PRODUCT
        value: chromium
    
    # Ù…ØªØºÙŠØ±Ø§Øª Ø­Ø³Ø§Ø³Ø© (ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ù„ÙˆØ­Ø© Render)
    # - TELEGRAM_BOT_TOKEN
    # - TELEGRAM_ADMIN_IDS
    # - ENCRYPTION_KEY
    # - API_SECRET_KEY
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù…
    healthCheckPath: /health
    dockerCommand: null
    dockerContext: .
    dockerfilePath: ./Dockerfile  # Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Docker
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØ³Ø¹
    scaling:
      minInstances: 1
      maxInstances: 2
      targetMemoryPercent: 80
      targetCPUPercent: 70
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
    privateService: false
    allowedHTTPMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
    security:
      enableTLS: true
      forceTLS: true
      cors:
        allowedOrigins:
          - "https://dashboard.render.com"
        allowedMethods:
          - GET
          - POST
        allowedHeaders:
          - Content-Type
          - Authorization
          - X-API-Key
    
    # ØªÙˆØ¬ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø´Ø±
    deploy:
      autoDeploy: true
      previewEnabled: true
      previewDeploymentHooks:
        buildCommand: npm run build
        startCommand: npm start
      rollbackOnFailure: true
      concurrency: 1
    
    # Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    monitoring:
      enabled: true
      alerts:
        - type: instance_count
          condition: "<"
          value: 1
          duration: "5m"
        - type: response_time
          condition: ">"
          value: 5000  # 5 Ø«ÙˆØ§Ù†ÙŠ
          duration: "10m"
        - type: error_rate
          condition: ">"
          value: 5  # 5%
          duration: "15m"
    
    # Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…
    resources:
      cpu: 1  # Ù†ÙˆØ§Ø©
      memory: 2048  # 2GB Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù€ Puppeteer
      disk: 10240  # 10GB
    
    # Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„
    schedules:
      - name: daily-backup
        schedule: "0 2 * * *"  # 2 ØµØ¨Ø§Ø­Ø§Ù‹ ÙƒÙ„ ÙŠÙˆÙ…
        command: "node scripts/backup.js"
      - name: cleanup-sessions
        schedule: "0 4 * * *"  # 4 ØµØ¨Ø§Ø­Ø§Ù‹ ÙƒÙ„ ÙŠÙˆÙ…
        command: "node scripts/cleanup.js"

# ============================================
# 3. Ø®Ø¯Ù…Ø© ÙˆÙŠØ¨ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
# ============================================
  - type: web
    name: whatsapp-bot-dashboard
    env: node
    region: frankfurt
    plan: starter
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
    buildCommand: |
      echo "ğŸŒ Ø¨Ù†Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…..."
      npm ci --only=production
      echo "âœ… Ø¨Ù†Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§ÙƒØªÙ…Ù„"
    
    # Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø¡
    startCommand: node dashboard/server.js
    
    # Ø§Ù„Ø¨ÙŠØ¦Ø©
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "10000"
      - key: API_SECRET_KEY
        sync: false
      - key: DASHBOARD_PASSWORD
        sync: false
    
    # Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
    rootDir: ./dashboard
    healthCheckPath: /status
    autoDeploy: true
    
    # Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
    resources:
      cpu: 0.5
      memory: 512
      disk: 512

# ============================================
# 4. Ø®Ø¯Ù…Ø© Cron Ù„Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©
# ============================================
  - type: cron
    name: bot-maintenance
    env: node
    region: frankfurt
    plan: starter
    
    # Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
    schedule: "*/30 * * * *"  # ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
    
    # Ø§Ù„Ø£Ù…Ø±
    command: node scripts/maintenance.js
    
    # Ø§Ù„Ø¨ÙŠØ¦Ø©
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: whatsapp-bot-db
          property: connectionString
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†ÙÙŠØ°
    timeout: 600  # 10 Ø¯Ù‚Ø§Ø¦Ù‚
    maxRetries: 3
    retryDelay: 60  # 60 Ø«Ø§Ù†ÙŠØ©

# ============================================
# 5. ØªØ®Ø²ÙŠÙ† Redis Ù„Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
# ============================================
redis:
  - name: whatsapp-bot-cache
    region: frankfurt
    plan: starter
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []
    
    # Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
    monitoring:
      enabled: true
      alerts:
        - type: memory
          threshold: 80
          duration: "5m"
    
    # Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    automaticBackups: true
    backupSchedule: "0 3 * * *"  # 3 ØµØ¨Ø§Ø­Ø§Ù‹ ÙƒÙ„ ÙŠÙˆÙ…

# ============================================
# 6. ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù„ÙØ§Øª (Ù„Ø¬Ù„Ø³Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨)
# ============================================
disk:
  - name: sessions-storage
    mountPath: /data/sessions
    sizeGB: 5
    
    # Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    backupSchedule: "0 1 * * *"
    backupRetention: 7

# ============================================
# 7. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†
# ============================================
network:
  # Ø´Ø¨ÙƒØ© Ø®Ø§ØµØ© Ø¯Ø§Ø®Ù„ÙŠØ©
  privateNetwork:
    enabled: true
    services:
      - whatsapp-bot-worker
      - whatsapp-bot-dashboard
      - whatsapp-bot-db
  
  # Ù‚ÙˆØ§Ø¹Ø¯ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ©
  firewall:
    - name: allow-telegram-webhooks
      port: 443
      source: "0.0.0.0/0"
      protocol: tcp
    - name: allow-dashboard
      port: 10000
      source: "0.0.0.0/0"
      protocol: tcp
  
  # Ù…ÙˆØ§Ø²Ù† Ø§Ù„Ø­Ù…Ù„
  loadBalancer:
    enabled: true
    ssl:
      enabled: true
      provider: letsencrypt
      domains:
        - your-domain.com
    stickySessions: true

# ============================================
# 8. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
# ============================================
observability:
  # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  logging:
    enabled: true
    retentionDays: 30
    includeFields:
      - timestamp
      - level
      - message
      - sessionId
      - adminId
    
    # ØªØµØ¯ÙŠØ± Ø§Ù„Ù„ÙˆØ¬Ø§Øª
    exports:
      - type: s3
        bucket: your-log-bucket
        schedule: "0 0 * * *"  # ÙŠÙˆÙ…ÙŠØ§Ù‹
  
  # Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³
  metrics:
    enabled: true
    collectionInterval: 60  # Ø«Ø§Ù†ÙŠØ©
    
    # Ù…Ù‚Ø§ÙŠÙŠØ³ Ù…Ø®ØµØµØ©
    customMetrics:
      - name: whatsapp_sessions_active
        query: "SELECT COUNT(*) FROM whatsapp_sessions WHERE status = 'active'"
        interval: 300
      - name: messages_sent_daily
        query: "SELECT SUM(messages_sent) FROM session_stats WHERE date = CURRENT_DATE"
        interval: 3600
  
  # Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
  alerts:
    channels:
      - type: email
        address: your-email@example.com
      - type: slack
        webhook: ${SLACK_WEBHOOK_URL}
      - type: telegram
        chatId: ${TELEGRAM_ALERT_CHAT_ID}
        botToken: ${TELEGRAM_BOT_TOKEN}
    
    # Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
    rules:
      - name: high-cpu-usage
        condition: "cpu.usage > 80"
        duration: "5m"
        channels: [email, telegram]
        
      - name: session-errors
        condition: "errors.count > 10"
        duration: "10m"
        channels: [slack, telegram]
        
      - name: no-active-sessions
        condition: "whatsapp_sessions_active == 0"
        duration: "30m"
        channels: [telegram]

# ============================================
# 9. Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ù†Ø´Ø±
# ============================================
deployment:
  strategy: rolling
  healthCheck:
    path: /health
    interval: 30
    timeout: 10
    retries: 3
    startPeriod: 60
  
  # Ø§Ù„Ù†Ø´Ø± Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ
  canary:
    enabled: false
    percentage: 10
    duration: 15m
  
  # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
  autoRestart:
    enabled: true
    maxRestarts: 3
    window: 3600  # Ø³Ø§Ø¹Ø©
  
  # Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
  updateWindow:
    start: "02:00"
    end: "04:00"
    timezone: "Asia/Riyadh"

# ============================================
# 10. Ø¹Ù„Ø§Ù…Ø§Øª ÙˆÙˆØ³ÙˆÙ…
# ============================================
tags:
  project: whatsapp-telegram-bot
  environment: production
  component: automation
  owner: ${OWNER_EMAIL}
  cost-center: marketing

# ============================================
# 11. Ù…Ø®Ø±Ø¬Ø§Øª Blueprint
# ============================================
outputs:
  database:
    host: ${whatsapp-bot-db.host}
    port: ${whatsapp-bot-db.port}
    name: ${whatsapp-bot-db.databaseName}
    
  services:
    worker: https://${whatsapp-bot-worker.onRenderUrl}
    dashboard: https://${whatsapp-bot-dashboard.onRenderUrl}
    
  endpoints:
    health: https://${whatsapp-bot-worker.onRenderUrl}/health
    api: https://${whatsapp-bot-worker.onRenderUrl}/api
    
  monitoring:
    logs: https://dashboard.render.com/logs/${whatsapp-bot-worker.serviceId}
    metrics: https://dashboard.render.com/metrics/${whatsapp-bot-worker.serviceId}

# ============================================
# 12. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø®ØµØµØ© Ù„Ù„Ù€ WhatsApp
# ============================================
whatsapp:
  # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø§Øª
  sessionManagement:
    autoReconnect: true
    reconnectDelay: 30000  # 30 Ø«Ø§Ù†ÙŠØ©
    maxReconnectAttempts: 5
    sessionTimeout: 86400000  # 24 Ø³Ø§Ø¹Ø©
    
  # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø´Ø±
  posting:
    maxGroupsPerHour: 100
    delayBetweenGroups: 1000  # 1 Ø«Ø§Ù†ÙŠØ©
    delayBetweenMessages: 2000  # 2 Ø«Ø§Ù†ÙŠØ©
    
  # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
  joining:
    maxJoinsPerHour: 20
    verifyGroups: true
    skipPrivateGroups: true
    
  # Ø§Ù„Ø£Ù…Ø§Ù†
  security:
    validateLinks: true
    sanitizeInput: true
    rateLimiting: true
    maxRequestsPerMinute: 60

# ============================================
# 13. Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
# ============================================
scripts:
  # Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
  backup:
    file: scripts/backup.js
    schedule: "0 2 * * *"
    retention: 7
    
  # Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªÙ†Ø¸ÙŠÙ
  cleanup:
    file: scripts/cleanup.js
    schedule: "0 4 * * *"
    
  # Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØµÙŠØ§Ù†Ø©
  maintenance:
    file: scripts/maintenance.js
    schedule: "*/30 * * * *"
    
  # Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
  monitor:
    file: scripts/monitor.js
    schedule: "*/5 * * * *"
